---
title: 计算机网络面试题汇总与解析：三次握手与四次挥手
date: 2025-02-06T12:03:30+08:00
tags: [前端]
series: []
featured: true
---
Hello! :wave:在网络通信和面试场景中，TCP协议的三次握手与四次挥手是必考的核心知识点。本文从面试题角度出发，结合底层原理和实际场景，整理高频问题并提供深度解析。

<!--more-->

---

### 一、基础概念与流程

#### **1. 三次握手过程**
**问题**：请描述TCP三次握手的具体流程。  
**答案**：  
1. **SYN**：客户端发送`SYN=1, seq=x`报文，进入`SYN_SENT`状态。  
2. **SYN-ACK**：服务端返回`SYN=1, ACK=1, seq=y, ack=x+1`，进入`SYN_RCVD`状态。  
3. **ACK**：客户端发送`ACK=1, seq=x+1, ack=y+1`，双方进入`ESTABLISHED`状态。  

**解析**：  
- **核心目标**：同步初始序列号（ISN），确保双方收发能力正常。  
- **为何是三次？** 避免历史重复连接的初始化（如延迟的旧SYN报文），同时确保双方确认彼此的收发能力。

---

#### **2. 四次挥手过程**
**问题**：为什么断开连接需要四次挥手？  
**答案**：  
1. **FIN**：主动关闭方（如客户端）发送`FIN=1`，进入`FIN_WAIT_1`。  
2. **ACK**：被动关闭方（如服务端）返回`ACK`，进入`CLOSE_WAIT`，客户端进入`FIN_WAIT_2`。  
3. **FIN**：服务端处理完数据后发送`FIN=1`，进入`LAST_ACK`。  
4. **ACK**：客户端返回`ACK`后进入`TIME_WAIT`，服务端关闭。  

**解析**：  
- **四次的原因**：TCP是全双工协议，需双方独立关闭通道。被动方可能需要时间处理剩余数据，因此ACK和FIN分开发送。  
- **TIME_WAIT的作用**：确保最后一个ACK能被接收（防止因丢包导致服务端重传FIN），同时让旧连接的报文在网络中消散（2MSL时间）。

---

### 二、高频进阶问题

#### **1. 握手时SYN洪泛攻击是什么？如何防御？**
**答案**：  
- **攻击原理**：攻击者伪造大量SYN报文但不回复ACK，耗尽服务端资源（半连接队列）。  
- **防御手段**：  
  - 启用`SYN Cookie`机制（通过哈希计算验证请求合法性，不占用队列）。  
  - 限制半连接队列大小或缩短SYN超时时间。

---

#### **2. 大量CLOSE_WAIT状态的可能原因？**
**答案**：  
- **现象**：服务端存在大量`CLOSE_WAIT`状态连接。  
- **原因**：应用程序未正确调用`close()`方法，导致服务端无法发送FIN报文。  
- **解决**：检查代码逻辑（如未关闭Socket、线程阻塞等）。

---

#### **3. 握手阶段能否携带数据？**
**答案**：  
- **第三次握手可以携带数据**：此时连接已建立，客户端确认服务端的收发能力。  
- **前两次不能**：若SYN报文携带数据，可能被恶意攻击者利用（如放大攻击）。

---

#### **4. TIME_WAIT状态为什么要等待2MSL？**
**答案**：  
- **MSL（Maximum Segment Lifetime）**：报文最大生存时间（通常30秒-2分钟）。  
- **2MSL的意义**：  
  - 确保被动方的FIN重传能被响应（若ACK丢失，被动方会重发FIN）。  
  - 让旧连接的报文在网络中失效，避免与新连接冲突。

---

### 三、实战场景与异常分析

#### **1. 服务端出现大量TIME_WAIT连接怎么办？**
**答案**：  
- **原因**：短连接频繁创建和关闭（如HTTP短连接）。  
- **优化方案**：  
  - 使用长连接（如HTTP Keep-Alive）。  
  - 修改内核参数（如`net.ipv4.tcp_tw_reuse`和`net.ipv4.tcp_tw_recycle`，需谨慎）。  

---

#### **2. 第二次握手丢失会发生什么？**
**答案**：  
- **客户端行为**：超时后重传SYN报文（指数退避）。  
- **服务端行为**：未收到ACK，停留在`SYN_RCVD`状态，直到超时丢弃连接。

---

#### **3. 如果服务端直接断电，TCP连接如何关闭？**
**答案**：  
- **无FIN报文**：客户端通过心跳机制（如Keep-Alive）检测到连接失效，主动发送RST复位连接。  
- **未启用心跳**：客户端可能长时间保持`ESTABLISHED`状态，直到应用层超时。

---

### 四、总结与面试技巧

1. **理解状态转换图**：熟记TCP的11种状态（如`SYN_SENT`、`TIME_WAIT`）及转换条件。  
2. **结合实际场景**：如高并发下的连接管理、服务器参数调优。  
3. **扩展知识**：对比UDP的无连接特性，理解TCP的可靠性设计（如序列号、超时重传）。  

**面试提示**：回答时结合抓包工具（Wireshark）分析握手/挥手过程，展示动手能力。

---

通过掌握三次握手与四次挥手的底层逻辑和异常处理，不仅能应对面试，更能为实际网络问题排查打下坚实基础。
